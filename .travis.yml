language: ruby
os: linux
dist: bionic
arch: arm64
services:
  - docker
jobs:
  - env: RAKE_TASK="apt:build" APT_TARGETS="debian-buster" ARCHIVE_BASE="debian-buster" PACKAGE_SYSTEM=apt
  - env: RAKE_TASK="apt:build" APT_TARGETS="ubuntu-bionic" ARCHIVE_BASE="ubuntu-bionic" PACKAGE_SYSTEM=apt
  # centos-release-scl isn't available for centos-7 on aarch64
  # TODO: Use rbenv instead
  # - env: RAKE_TASK="yum:build" YUM_TARGETS="centos-7" ARCHIVE_BASE="centos-7" PACKAGE_SYSTEM=yum
  - env: RAKE_TASK="yum:build" YUM_TARGETS="centos-8" ARCHIVE_BASE="centos-8" PACKAGE_SYSTEM=yum
script:
  - rake $RAKE_TASK
before_deploy:
  - export RELEASE_DIRECTORY="td-agent/${PACKAGE_SYSTEM}/repositories/"
  - tar cJvf package-${ARCHIVE_BASE}-arm64.tar.xz td-agent/${PACKAGE_SYSTEM}/repositories
  - echo "deploying tarball includes the following directory:"
  - echo "${RELEASE_DIRECTORY}"
deploy:
  provider: releases
  token:
    secure: "Z77Lt0KX5GHyBK1oRCLY3E88g12uRJX1GaYbrtZ0gG1P2q7soq07fW6trROBx6N3xN7WYwCm4S68VRd6CDBcTjXcs3dcWGykF8ymuApA7DMnv6u2lh+U0W6ERLdsN1Lk3SbN6lgnpKaKoF/E9uAbbRJJQMwTOkK88NKEWPq17TgtcawCHF6LgOIYKG13Ot3ydsKfgsmtduxQX+9d01Ue6WGNysgJoKG6MMKSHFWqhnC3VnmWLiA6LhoQhkHv583EMoTTra5G7y45ouyopNjEiAnwD6DSprrcu0IU8ybO1zf5oQGvfJcY2S8vhYMKjcfpnTOpjnFD2nJAjmHh4SP4pY+xmDfB4NP55vZMmj/KTv2PkSzxjmn/Ll8Gl+zkDQNPoXdSJK+/4AxPtpdrRLF0bHJc1ndthcOheMdXpPUkCLC38Gz/p295WsH8r/xmI2cBhQZiI/vjB+rJXc1GiSRv2E9fiY/D17tbOsX54be6rh62yhqsXbhz1/JrP9wFxtqyHnr7kwIjHQ3yYxVLeZ6g4jCtlEiOCeQtts2B0IbdPLOSvOT1AfgFoXmwkaQnopfZA4OAY2EKkwDCnh2ZIJKc2d6zgARYkNkACQ2N6YfeP2i7SOaGSYhPVIhnLAznMvMd9iKKt+Hz/AF6/2+y9OgqP08TkDlEQbyP/F/uwyhomAs="
  file_glob: true
  skip_cleanup: true
  file: "package-*-arm64.tar.xz"
  on:
    tags: true
